<?php/** * Created by PhpStorm. * User: Addictive * Date: 23/07/2017 * Time: 20:56 */class DatabaseInserter{    public static $TELECOMMUNICATIONS = 100;    public static $PEOPLE = 101;    private $DATA;    private $SET;    private $MODE;    private $INSERTED_NUMBERS = 0;    private $DUBLICATE_NUMBERS = 0;    private $PROCESSED_NUMBERS = 0;    private $INSERTED_COMS = 0;    private $DUBLICATE_COMS = 0;    private $PROCESSED_COMS = 0;    private $INSERTED_PEOPLE = 0;    private $DUBLICATE_PEOPLE = 0;    private $PROCESSED_PEOPLE = 0;    private $INSERTED_ASSOCS = 0;    private $DUBLICATE_ASSOCS = 0;    private $PROCESSED_ASSOCS = 0;    public function __construct($dataArray, $set, $mode)    {        $this->DATA = $dataArray;        $this->SET = $set;        $this->MODE = $mode;    }    public function insertData() {        if($this->MODE == DatabaseInserter::$TELECOMMUNICATIONS) {            $this->insertTelecommunications();        }        if($this->MODE == DatabaseInserter::$PEOPLE) {            $this->insertPeople();        }        return array("INSERTED_NUMBERS" => $this->INSERTED_NUMBERS,                     "DUBLICATE_NUMBERS" => $this->DUBLICATE_NUMBERS,                     "PROCESSED_NUMBERS" => $this->PROCESSED_NUMBERS,                     "INSERTED_COMS" => $this->INSERTED_COMS,                     "DUBLICATE_COMS" => $this->DUBLICATE_COMS,                     "PROCESSED_COMS" => $this->PROCESSED_COMS,                     "PROCESSED_ASSOCS" => $this->PROCESSED_ASSOCS,                     "DUBLICATE_ASSOCS" => $this->DUBLICATE_ASSOCS,                     "INSERTED_ASSOCS" => $this->INSERTED_ASSOCS,                     "PROCESSED_PEOPLE" => $this->PROCESSED_PEOPLE,                     "DUBLICATE_PEOPLE" => $this->DUBLICATE_PEOPLE,                     "INSERTED_PEOPLE" => $this->INSERTED_PEOPLE            );    }    //insert telecommunications    private function insertTelecommunications() {        $tempDATA = $this->DATA;        if(count($tempDATA) == 0 || $tempDATA == null) { return; }        $pdo = DB::get()->dbh;        //first make a tempArray for the numbers        $telephones = array();        foreach ($tempDATA as $com) {            if (!$this->containsTelephone($com->getCaller(), $telephones)) {                array_push($telephones, $com->getCaller());                $this->PROCESSED_NUMBERS++;            }            if (!$this->containsTelephone($com->getCalled(), $telephones)) {                array_push($telephones, $com->getCalled());                $this->PROCESSED_NUMBERS++;            }        }        //first insert the telephone numbers/devices        $insert_query = "";        $insert_query .= "INSERT IGNORE INTO ix_telephone_number (`number`, `type`, `country_code`) VALUES ";        foreach ($telephones as $t) {            $ccode = !$t->getCountryCode()?"NULL": "'" . $t->getCountryCode() . "'";            $insert_query .= "('" . $t->getNumber() . "', '" . $t->getType() . "', " . $ccode . "), ";        }        $insert_query = substr($insert_query, 0, strlen($insert_query) - 2);        $insert_query .= ";";        $pdo->beginTransaction();        $stmt = $pdo->prepare($insert_query);        try {            $stmt->execute();            $this->INSERTED_NUMBERS += $stmt->rowCount();        } catch(PDOException $e) {            throw $e;        }        $pdo->commit();        //calculate the dublicates by subtracting the inserted from the total (processed)        $this->DUBLICATE_NUMBERS = $this->PROCESSED_NUMBERS - $this->INSERTED_NUMBERS;        //if a set name has been provided        if ($this->SET != "no_set") {            $insert_query = "INSERT IGNORE INTO ix_datasets_telephone_numbers (`set_name`, `number`) VALUES ";            foreach ($telephones as $t) {                $insert_query .= "('" . $this->SET . "', '" . $t->getNumber() . "'), ";            }            $insert_query = substr($insert_query, 0, strlen($insert_query) - 2) . ";";            $pdo->beginTransaction();            //run the query to get all the inserted ids and insert them to the set as well            $stmt = $pdo->prepare($insert_query);            try {                $stmt->execute();            }catch(PDOException $e) {                throw $e;            }            $pdo->commit();        } //end of if there is a set block        //then append the telecommunications query        $insert_query = "";        $insert_query .= "INSERT IGNORE INTO ix_telecommunications (`telephone_1`, `telephone_2`, `time_stamp`, `duration`, `weight`, `type`) VALUES ";        foreach ($tempDATA as $com) {            $insert_query .= "('" . $com->getCaller()->getNumber() . "', '" . $com->getCalled()->getNumber() . "', " . $com->getTimestampInt() . ", " . $com->getDuration() . ", " . number_format($com->getWeight(), 1, '.', ',') . ", '" . $com->getType() . "'), ";            $this->PROCESSED_COMS++;        }        $insert_query = substr($insert_query, 0, strlen($insert_query) - 2) . ";";        $pdo->beginTransaction();        $stmt = $pdo->prepare($insert_query);        try {            $stmt->execute();            $this->INSERTED_COMS += $stmt->rowCount();        }catch(PDOException $e) {            throw $e;        }        $pdo->commit();        $this->DUBLICATE_COMS = $this->PROCESSED_COMS - $this->INSERTED_COMS;        //if a set name has been provided        if ($this->SET != "no_set") {            $insert_query = "INSERT IGNORE INTO ix_datasets_telecommunications (`set_name`, `caller`, `called`, `time_stamp`, `duration`) VALUES ";            foreach ($tempDATA as $com) {                $insert_query .= "('" . $this->SET . "', '" . $com->getCaller()->getNumber() . "', '" . $com->getCalled()->getNumber() . "', " . $com->getTimestampInt() . ", " . $com->getDuration() . "), ";            }            $insert_query = substr($insert_query, 0, strlen($insert_query) - 2) . ";";            $pdo->beginTransaction();            //run the query to get all the inserted ids and insert them to the set as well            $stmt = $pdo->prepare($insert_query);            try {                $stmt->execute();            }catch(PDOException $e) {                throw $e;            }            $pdo->commit();        } //end of if there is a set block    }    private function insertPeople() {        $tempDATA = $this->DATA;        if(count($tempDATA) == 0 || $tempDATA == null) { return; }        $pdo = DB::get()->dbh;        //first make a tempArray for the numbers        $telephones = array();        $people = array();        foreach ($tempDATA as $rec) {            if (!$this->containsTelephone($rec['telephone'], $telephones)) {                array_push($telephones, $rec['telephone']);                $this->PROCESSED_NUMBERS++;            }            if($rec['person']->isValid()) {                array_push($people, $rec['person']);                $this->PROCESSED_PEOPLE++;            }            $this->PROCESSED_ASSOCS++;        }        //first insert the telephone numbers/devices        $insert_query = "";        $insert_query .= "INSERT IGNORE INTO ix_telephone_number (`number`, `type`, `country_code`) VALUES ";        foreach ($telephones as $t) {            $ccode = !$t->getCountryCode()?"NULL": "'" . $t->getCountryCode() . "'";            $insert_query .= "('" . $t->getNumber() . "', '" . $t->getType() . "', " . $ccode . "), ";        }        $insert_query = substr($insert_query, 0, strlen($insert_query) - 2);        $insert_query .= ";";        $pdo->beginTransaction();        $stmt = $pdo->prepare($insert_query);        try {            $stmt->execute();            $this->INSERTED_NUMBERS += $stmt->rowCount();        } catch(PDOException $e) {            throw $e;        }        $pdo->commit();        //calculate the dublicates by subtracting the inserted from the total (processed)        $this->DUBLICATE_NUMBERS = $this->PROCESSED_NUMBERS - $this->INSERTED_NUMBERS;        //if a set name has been provided        if ($this->SET != "no_set") {            $insert_query = "INSERT IGNORE INTO ix_datasets_telephone_numbers (`set_name`, `number`) VALUES ";            foreach ($telephones as $t) {                $insert_query .= "('" . $this->SET . "', '" . $t->getNumber() . "'), ";            }            $insert_query = substr($insert_query, 0, strlen($insert_query) - 2) . ";";            $pdo->beginTransaction();            //run the query to get all the inserted ids and insert them to the set as well            $stmt = $pdo->prepare($insert_query);            try {                $stmt->execute();            }catch(PDOException $e) {                throw $e;            }            $pdo->commit();        } //end of if there is a set block        //then insert the persons numbers/devices        $insert_query = "";        $insert_query .= "INSERT IGNORE INTO ix_persons (`id_number`, `ssn`, `surname`, `name`, `gender`, `alias`, `address`, `fathersname`, `mothersname`, `birthdate`, `country`) VALUES ";        foreach ($people as $p) {            $date = $p->getBirthdate();            if(!$date || $date == "" || $date == null) {                $datSt = "NULL";            } else {                //die("check" . $p->getBirthdate());                $datSt = "'" . intToSqlDate(dateToInt($p->getBirthdate())) . "'";            }            if($datSt == "0000-00-00") {                $datSt = "NULL";            }            $alias = $p->getAlias()!="NULL"?"'".$p->getAlias()."'":"NULL";            $address = $p->getAddress()!="NULL"?"'".$p->getAddress()."'":"NULL";            $fathersname = $p->getFathername()!="NULL"?"'".$p->getFathername()."'":"NULL";            $mothername = $p->getMothername()!="NULL"?"'".$p->getMothername()."'":"NULL";            $country = $p->getCountry()!="NULL"?"'".$p->getCountry()."'":"NULL";            $ssn = $p->getSSN()!="NULL"?"'".$p->getSSN()."'":"NULL";            $insert_query .= "('" . $p->getIdNum() . "', " . $ssn . ", '" . $p->getSurname() . "', '" . $p->getName() . "', '" . $p->getGender() . "', " . $alias . "            , " . $address . ", " . $fathersname . ", " . $mothername . ", " . $datSt . ", " . $country . "), ";        }        $insert_query = substr($insert_query, 0, strlen($insert_query) - 2);        $insert_query .= ";";        $pdo->beginTransaction();        $stmt = $pdo->prepare($insert_query);        try {            $stmt->execute();            $this->INSERTED_PEOPLE += $stmt->rowCount();        } catch(PDOException $e) {            throw $e;        }        $pdo->commit();        $this->DUBLICATE_PEOPLE = $this->PROCESSED_PEOPLE - $this->INSERTED_PEOPLE;        //then append the people query        $insert_query = "";        $insert_query .= "INSERT IGNORE INTO ix_persons_telephones (`id_number`, `surname`, `name`, `telephone_number`, `relationship`, `validity`) VALUES ";        foreach ($tempDATA as $rec) {            $person = $rec['person'];            $telephone = $rec['telephone'];            $insert_query .= "('".$person->getIdNum()."', '".$person->getSurname()."', '".$person->getName()."', '" . $telephone->getNumber() . "', 'owns', 'A1'), ";        }        $insert_query = substr($insert_query, 0, strlen($insert_query) - 2) . ";";        $pdo->beginTransaction();        $stmt = $pdo->prepare($insert_query);        try {            $stmt->execute();            $this->INSERTED_ASSOCS += $stmt->rowCount();        }catch(PDOException $e) {            throw $e;        }        $pdo->commit();        $this->DUBLICATE_ASSOCS = $this->PROCESSED_ASSOCS - $this->INSERTED_ASSOCS;    }    private function containsTelephone($telephone, $array) {        foreach($array as $tel) {            if($tel->getNumber() == $telephone->getNumber()) {                return true;            }            return false;        }    }}?>